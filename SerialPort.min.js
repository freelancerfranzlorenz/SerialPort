// Copyright(c) by Franz Lorenz, Kelheimwinzerstr.21f,93309 Kelheim
class SerialPort{constructor(){this.Port=null,this.aBaudrates=[110,300,600,1200,2400,4800,9600,14400,19200,38400,57600,115200,128e3,256e3],this.Settings={baudRate:9600,dataBits:8,stopBits:1,parity:"none",bufferSize:255,flowControl:"none"},this.sLineEnd="\n",this.sRxBuffer="",this.Reader=null,this.keepReading=!0}setDataBits7(){this.Settings.dataBits=7}setDataBits8(){this.Settings.dataBits=8}setStopBits1(){this.Settings.stopBits=1}setStopBits2(){this.Settings.stopBits=2}setParityNone(){this.Settings.parity="none"}setParityEven(){this.Settings.parity="even"}setParityOdd(){this.Settings.parity="odd"}setBufferSize(t){this.Settings.bufferSize=t}setFlowCtrlNone(){this.Settings.flowControl="none"}setFlowCtrlHardware(){this.Settings.flowControl="hardware"}setLineEnd(t){this.sLineEnd=t}setBaudrate(t){let e=!1;return this.aBaudrates.indexOf(t)>=0&&(this.Settings.baudRate=t,e=!0),e}isAvailable(){return"serial"in navigator}isOpen(){return null!=this.Port}_buffer(t){this.sRxBuffer+=t;let e=this.sRxBuffer.split(this.sLineEnd);for(;e.length>1;)this.callCallback("read",e.shift());this.sRxBuffer=e[0]}async open(){try{this.Port=await navigator.serial.requestPort();try{for(await this.Port.open(this.Settings),this.callCallback("open"),this.keepReading=!0,this.sRxBuffer="";this.Port.readable&&this.keepReading;){this.Reader=this.Port.readable.getReader();try{for(;this.keepReading;){let{value:t,done:e}=await this.Reader.read();if(e)break;if(t){let i=new TextDecoder().decode(t);this.sLineEnd.length>0?this._buffer(i):this.callCallback("read",i)}}}catch(s){}finally{this.Reader.releaseLock()}}await this.Port.close(),this.Port=null,this.callCallback("close")}catch(a){this.callCallback("error","open")}}catch(r){this.callCallback("break","open"),this.Port=null}}async write(t){if(null!=this.Port){let e=Serial.Port.writable.getWriter();await e.write(new TextEncoder("utf-8").encode(t)),e.releaseLock()}else callbackSerialPort("error","write")}async writeln(t){this.write(t+this.sLineEnd)}async close(){this.keepReading=!1,this.Reader.releaseLock()}callCallback(t,e){"function"==typeof callbackSerialPort&&callbackSerialPort(t,e)}}
